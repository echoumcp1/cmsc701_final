import textwrap
import requests
import csv

# tax_ids = ['1423893', '445932', '1121441', '342944', '1761453', '213224', '2599305', False, '987066', '83765', '407022', '2716930', '2675299', '28122', '1725252', '343240', '1960125', '454154', '123320', '485915', '148813', '323450', '1206085', '390637', '1121936', '1296344', '1150368', '2049305', '2547397', False, '1163617', '981385', '562969', '563', '466109', '173560', '2570355', False, '2558931', '1828758', '398512', '2661937', '641691', False, '1577687', '1868734', '932217', '1104781', '1246637', '33984', '237611', '1122184', '1387277', '632773', '2352', '2292766', '229919', '85831', '229921', '46125', '1120983', '1979269', '2219043', '2528527', '379075', '170623', '133535', '446462', '1890295', False, '2528021', '2718', '1208313', False, '1809410', '1120992', '2792783', '313985', '415222', '2304626', '274537', '2775968', '39483', '472055', '1777142', '509200', '405555', '37921', '913108', '673379', '2753746', '2028108', '1720247', '2706888', '661191', '184870', '1122934', '595589', '14', '1213861', '1323375', '1120963', '47735', '682798', '2133944', '2743469', '59561', '1121875', '1041766', '2583587', '592377', '1196416', '977794', '1007096', '545695', '246264', '285351', '153266', '209880', '1720261', '51101', '1686287', '517418', '417203', '1415779', '515897', '991905', '678932', '384933', '2164132', False, '1531429', '81029', '2898187', '927668', '2606629', '314283', '1223410', '227924', '1173020', '563172', '58180', '1235284', '69359', '1340493', '1674942', '2316528', '2763670', '1123274', '2593303', '1852029', '7', '304207', '29394', '1479485', '980252', '903818', '490979', '1903261', '942938', '74426', '1444977', '564137', '2691583', '1104777', '426756', '1216062', '2596893', '2371', '2607284', '2584122', '1484056', '1521533', '2593653', '1632858', '2588711', '61647', '1914409', '1796652', '2728837', '614649', '433647', '2731377', '1926625', '120213', '407036', '48467', '2006', '2479004', '2601703', '1123242', '2714355', '1339210', '404380', '2511025', '1285193', '670289', '1223', '263476', '412034', '1513793', '2164067', '621', '620910', '1749045', '574349', '2182384', '1235591', '254357', '2819369', '763993', '29443', '2692629', '297', '471499', '1524974', '258723', '2670334', '146940', '2060066', False, '1123508', '755178', '1605367', '2594883', '253239', '210994', '575540', '101383', '2775866', '472059', False, '1236954', '1911682', '2774144', '2590031', '366582', '427920', '320787', '555500', '520767', '310355', '716817', '525904', '176102', '118168', '2171751', '592308', '1304888', '1986204', '741659', '1708749', '1748220', '1196024', '2094151', '591197', '216931', '2750659', '266809', '1391', '335543', '1254', '61654', '76980', '1197174', '1810504', '1892904', '220378', '279828', '1352348', '1964395', '797292', '2716334', '2585771', '35835', '879566', '2789776', '309801', '1123504', '1442381', '2234133', '1211326', '1917421', '54067', '2875764', '913099', '1410651', False, '28077', '1123507', '1859475', '373681', '1247514', '670293', '404875', '92172', '557451', '2007306', '2761453', '1639882', '1200284', '593135', '1264', '1074', '1852361', '493385', '2545761', '82805', '1168171', False, '1524264', '283736', '1912897', '2591009', '1121020', '414052', '1549641', '422442', '1304885', '2528024', '1299998', '2675772', '2804194', '51288', '660294', '361183', '2175228', '1121952', '1130080', False, '682562', '1776034', '1582356', '2880968', '151894', '2496270', '29408', '1009370', '2698', '2590451', '2527968', '620914', '911197', '1120985', False, '550447', '2136177', False, '483423', '347255', '1548547', '2590786', '1717717', '1329516', '2599296', '1089547', '2479848', '199596', '2108365', '314319', '1855912', '522448', '765909', '631454', '2715756', '2675054', '114527', '1521930', '157692', '2716227', '2591008', '1105367', '2856608', '698769', '33025', '1963835', '2029117', '146938', '2527995', '1689303', False, '2600177', '1034346', '1547597', '1123382', '2739434', False, '35754', '980251', '1891921', '213248', '915173', False, '751', '1929246', '1121413', '487174', '1227549', '49280', '2569541', '260552', '31973', '598659', '109327', '1182451', '155197', '2565934', '41', '1635327', '1326', '2795974', '1121388', '393762', '1874116', '2491023', '1082479', '2571148', False, '336988', '1384459', '142588', '2710484', '2486577', '2495581', '2662258', '28094', '46469', '1629051', '2249428', '349215', '454171', '295255', '1691903', False, '2759037', '2696054', '191292', '2810036', '411483', '643052', '2509459', '2726742', '1401087', '2304675', '2772557', '1848972', '1121403', '1267768', '2932264', '225937', '2681495', '28447', '58119', '2780383', '28907', '653940', '34059', '561184', '1073253', '2834768', '1286186', '1804625', '1748', '1542388', '2583452', False, '714', '139438', '1443036', '2755358', '571115', '1196421', '1506996', '1850246', '2002841', '1279009', '66863', '1224947', '137730', '34068', '163359', '1851148', '1475481', '1445657', '2282477', False, '2759035', '749222', '1751298', '1252', '437897', '2007307', '39029', '502025', '743966', '2784339', '1197906', '2486419', '272239', '1351585', '2588534', '1380675', '2182793', '214851', '2729623', '70586', '645517', '1826607', '586416', '468556', '1740263', '2652290', '2013869', '1548548', '457575', '2692623', '2478538', '2448162', '2745851', '1048339', '28034', '1505597', '1204385', '990', '313606', False, '670482', '2715279', '496014', '39485', '1162967', '1121289', '638303', '1297424', '39486', '1862672', '417367', '2751313', '2860338', False, '1338687', '391612', '564369', '2805098', '1123236', '1735038', '990373', False, '263852', '1077255', '1510150', '2735915', '1735103', '1940615', False, False, '2893202', '886464', '84163', '385492', '1123070', '556325', False, '176709', '1592106', '390641', '2562892', '166485', '1245525', '2292702', '642776', '218139', '1120989', '34017', '528178', '278957', False, False, '2613962', '1526573', '1293442', '2486576', '1572762', '2707016', '1336250', '2582419', '80866', '83552', '2731212', '406100', '1891207', '487175', '57040', '1087', '2663379', '1605990', '39647', '1803916', '2793297', '2099400', '1294296', '689904', '2755051', '1197950', '202789', '2766537', '39480', '2714955', '1469144', '2021234', '366533', '2591109', '346911', '2161814', '1484053', '643671', '1278643', '1871030', '642492', '72', '1600', '2757', '1398745', '571166', False, '1707096', '2606906', '1715691', '2530354', '328517', '1077947', '177439', '373903', '2726450', '2778369', '2496273', '254246', '1262554', False, '37625', '650004', '215813', '1231350', '13335', '927', '164516', '311182', '520092', '1585976', '1323734', '1000566', '2584944', '1850361', '349934', '1082276', '1123230', '477976', '1290553', '913107', '1294020', '207949', '81425', '645466', '2493082', '539', '202462', '1442370', False, '4950', '1340429', '559297', '559292', '644352', '578459', '870730', '486041', '231269', '671987', '236234', False, '336963', '280036', '1141098', '470096', '721885', '264951', '756982', '694068', '5007', '684364', '931890', '5016', '246410', '240176', '45607', '1522189', '578456', '1354746', '1245769', '1229662', '698492', '1168221', '665079', '984486', '152316', '425265', '284813', '588596', '732165', '1380566', '1912982', '1365824', '33412', '6239', '561572', '116150', '7741', '935657', '7054', '7227', '121224', '7654', '35570', '6573', '7493', '103933', '7725', '460826', '109461', '70779', '115081', '139456', '6185', '609295', '742174', '7048', '6210', '6941', '202533', '13686', '1477025', '343691', '222816', '6954', '158441', '7396', '34506', '6945', '13164', '218467', '48498', '185431', '1410327', '88456', '94643', '5855', '261658', '464988', '5874', '280463', '59472', '95912', '59479', '9704', '9258', '39432', '61383', '9365', '447135', False, '9689', '61853', '494514', '10089', '109478', '9696', '10116', '27675', '38626', '246437', '10090', '50954', '286419', '9606', '61156', '81572', '33562', '9657', '9595', '1706337', '27622', '57068', '31033', '8364', '158456', '1825980', '7897', '7998', '9209', '106582', '42526', '7918', '160734', '59729', '52670', '8255', '41447', '7830', '121530', '30410', '415028', '208333', '57412', '215358', '278164', '47969', '59861', '8845', '8520', '181119', '8218', '7955', '2696672', '42514', '74926', '80427', '85066', '8932', '8175', '9054', '7962', '84834', '176057', '128390', '94827', '147949', '9157', '8478', '35005', '33528', '31138', '80972', '40157', '451745', '87175', '8790', '244447', '205130', False, False]
tax_ids = []
def process_assembly_report(url):
    split_point = url.find("/latest_assembly_versions/")
    if split_point == -1:
        return False
    url = f"{url[:split_point]}/assembly_summary.txt"
    response = requests.get(url)
    if response.status_code != 200:
        print(f"Failed to download the file from {url}. Status code: {response.status_code}")
        return False

    content = response.text
    lines = content.splitlines()    
    tax_id_index = lines[1].split("\t").index('taxid')
    return lines[2].split("\t")[tax_id_index]

input_csv_path = 'data/genomic_species.csv'
with open(input_csv_path, newline='') as infile, open("data/genomic_species.fa", 'w', newline='') as outfile:
    i = 0
    reader = csv.DictReader(infile)
    for row in reader:
        sequence = row['sequence']
        group = row['group']
        genus = row['genus']
        species_epithet = row['species_epithet']
        base_url = row['original_url']
        tax_id = process_assembly_report(base_url)
        fasta_header = f">{group}_{genus}_{species_epithet}|kraken:taxid|{tax_id}"
        wrapped_sequence = "\n".join(textwrap.wrap(sequence, width=80))

        outfile.write(f"{fasta_header}\n{wrapped_sequence}\n")
        i += 1

